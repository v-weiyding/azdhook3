name: Run azd hooks
trigger: none

pool:
  vmImage: ubuntu-latest

parameters:
  - name: subscriptionId
    displayName: subscription id
    type: string
    # test 生产环境下删除
    default: "faa080af-c1d8-40ad-9cce-e1a450ca5b57"
  - name: location
    displayName: location
    type: string
    default: "eastus2"


jobs:
  - job: RunHooks
    steps:
      - task: Bash@3
        displayName: Install azd
        inputs:
          targetType: inline
          script: |

            curl -fsSL https://aka.ms/install-azd.sh | bash -s -- --version daily


      - task: Bash@3
        displayName: Install template
        inputs:
          targetType: inline
          script: |

            azd version

            azd config set auth.useAzCliAuth "true"
            azd config set defaults.subscription ${{ parameters.subscriptionId }}
            azd config set defaults.location ${{ parameters.location }}

            environmentName="sdkazdhook$(uuidgen | cut -c 1-6)"
            azd init -e $environmentName

      - task: Bash@3
        displayName: Replace azure.yaml file
        inputs:
          targetType: inline
          script: |


            yamlFile=$(cat ./hooks/1.ps1 )
            echo $yamlFile > 2.txt

            cat 2.txt
            
            path1="./hooks"
            yamlFile2=$(cat $path1/1.ps1 )
            echo $yamlFile2 >> 2.txt

            cat 2.txt
            chmod +x ./hooks/1.sh
            ./hooks/1.sh 1111 2222

      - task: AzureCLI@2
        displayName: Run azd hooks
        inputs:
          azureSubscription: tomServiceConnection1
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |


            chmod +x ./hooks/1.sh

            azd up --no-prompt
            
            # test
            # azd package 
            # azd restore

            sleep 10

            azd down --purge --force


            popd

